name: ğŸ” Database Security & DLP Pipeline

on:
  push:
    paths:
      - '**.py'
      - '**.yml'
  workflow_dispatch:

jobs:
  secure-db-lifecycle:
    runs-on: ubuntu-latest
    
    # [ì¤‘ìš”] GitHub Actions ë‚´ì— ê²©ë¦¬ëœ PostgreSQL ì»¨í…Œì´ë„ˆ ìƒì„±
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        # DBê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°í•˜ëŠ” í—¬ìŠ¤ì²´í¬
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (DLP ìŠ¤ìº”ìš©)

      # ==========================================
      # [DLP: ì™¸ë¶€ ìœ ì¶œ ë°©ì§€ í”„ë¡œê·¸ë¨ (Gitleaks)]
      # ==========================================
      - name: ğŸš¨ Gitleaks Secret Scanner
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: false # ë¹„ë°€ë²ˆí˜¸ ë°œê²¬ ì‹œ ì¦‰ì‹œ ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨

      - name: ğŸ Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ğŸ“¦ ë³´ì•ˆ/DB ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
        run: |
          pip install psycopg2-binary cryptography

      - name: ğŸ›¡ï¸ ë³´ì•ˆ DB ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (Table/Query/Encrypt)
        env:
          # ì‹¤ì œ í™˜ê²½ë³€ìˆ˜ëŠ” GitHub Secretsì—ì„œ ê´€ë¦¬í•´ì•¼ í•¨
          DB_HOST: localhost
          DB_USER: postgres
          DB_PASS: password
        run: |
          python secure_db_ops.py
