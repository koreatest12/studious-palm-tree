name: ğŸ” Database Security & DLP Pipeline

on:
  push:
    paths:
      - '**.py'
      - '**.yml'
  workflow_dispatch: # [ì¤‘ìš”] ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ í™œì„±í™”

jobs:
  secure-db-lifecycle:
    runs-on: ubuntu-latest
    
    # [DevSecOps] ê²©ë¦¬ëœ PostgreSQL ì»¨í…Œì´ë„ˆ ìë™ ìƒì„±
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        # DB í—¬ìŠ¤ì²´í¬ (DBê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°)
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # [Image of DevSecOps pipeline diagram]
      # ìœ„ íƒœê·¸ëŠ” DevSecOps íë¦„ì„ ì‹œê°í™”í•©ë‹ˆë‹¤. (ì½”ë“œ -> ìŠ¤ìº” -> í…ŒìŠ¤íŠ¸)

      # ==========================================
      # [DLP: 1ì°¨ ë°©ì–´ì„  - ë¹„ë°€ë²ˆí˜¸/í‚¤ ìœ ì¶œ ìŠ¤ìº”]
      # ==========================================
      - name: ğŸš¨ Gitleaks Secret Scanner
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: false 

      - name: ğŸ Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ğŸ“¦ í•„ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
        run: |
          pip install psycopg2-binary cryptography

      # ==========================================
      # [Security Ops: 2ì°¨ ë°©ì–´ì„  - ë³´ì•ˆ ë¡œì§ ì‹¤í–‰]
      # ==========================================
      - name: ğŸ›¡ï¸ ë³´ì•ˆ DB ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        env:
          # GitHub Actions ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ ì •ë³´ ì£¼ì…
          DB_HOST: localhost
          DB_NAME: testdb
          DB_USER: postgres
          DB_PASS: password
        run: |
          # ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ê°€ ë‚˜ë¯€ë¡œ í™•ì¸ í›„ ì‹¤í–‰
          if [ -f secure_db_ops.py ]; then
            python secure_db_ops.py
          else
            echo "âŒ Error: secure_db_ops.py íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
